# V1.1.3 ä¿®å¤æŒ‡å—ï¼šè§£å†³"è¿žæŽ¥æ–­å¼€"é”™è¯¯

## ðŸ”§ å·²å®Œæˆçš„ä¿®æ”¹

### 1. Manifest.json âœ…
- ç‰ˆæœ¬å·æ›´æ–°ä¸º 1.1.3
- downloads æƒé™å·²å­˜åœ¨ âœ…
- host_permissions åŒ…å« googleusercontent.com âœ…

### 2. Background.js âœ…
- **å·²å®Œå…¨é‡å†™**ä¸ºç®€åŒ–ç‰ˆæœ¬
- ä¸“æ³¨äºŽä¸‹è½½åŠŸèƒ½
- å…³é”®ä¿®å¤ï¼š`return true` ä¿æŒå¼‚æ­¥é€šé“

### 3. Content.js âš ï¸ éœ€è¦æ‰‹åŠ¨æ›¿æ¢

## ðŸ“ æ‰‹åŠ¨æ“ä½œæ­¥éª¤

### æ­¥éª¤1ï¼šæ›¿æ¢ downloadImageAsync å‡½æ•°

1. æ‰“å¼€ `content.js`
2. æ‰¾åˆ° `downloadImageAsync` å‡½æ•°ï¼ˆçº¦ç¬¬413è¡Œï¼‰
3. **å®Œå…¨åˆ é™¤**çŽ°æœ‰çš„ `downloadImageAsync` å‡½æ•°
4. å¤åˆ¶ `download_v113.js` ä¸­çš„æ–°å‡½æ•°åˆ°ç›¸åŒä½ç½®

### æ­¥éª¤2ï¼šç¡®è®¤ä¸‹è½½è°ƒç”¨å·²å¯ç”¨

åœ¨ `handleGenerateImage` å‡½æ•°ä¸­ï¼Œç¡®è®¤ç¬¬86-93è¡Œçš„ä¸‹è½½è°ƒç”¨å·²å–æ¶ˆæ³¨é‡Šï¼š

```javascript
// ========== æ­¥éª¤ 6: ä¸‹è½½å›¾ç‰‡ ==========
console.log(`[æ­¥éª¤ 6/${index}] ä¸‹è½½å›¾ç‰‡...`);
try {
  await downloadImageAsync(index);
  console.log(`âœ… ç¬¬ ${index}/${total} å¼ å›¾ç‰‡ä»»åŠ¡å®Œæˆ`);
} catch (downloadError) {
  console.error(`âŒ ä¸‹è½½å¤±è´¥ï¼Œä½†ç»§ç»­ä¸‹ä¸€å¼ :`, downloadError);
}
```

## ðŸŽ¯ æ ¸å¿ƒä¿®å¤ç‚¹

### Background.js çš„å…³é”®æ”¹è¿›

**ä¿®å¤å‰ï¼ˆé”™è¯¯ï¼‰ï¼š**
```javascript
chrome.downloads.download({...}, (downloadId) => {
  sendResponse({...});
});
// âŒ ç¼ºå°‘ return trueï¼Œé€šé“è¿‡æ—©å…³é—­
```

**ä¿®å¤åŽï¼ˆæ­£ç¡®ï¼‰ï¼š**
```javascript
chrome.downloads.download({...}, (downloadId) => {
  sendResponse({...});
});
return true; // âœ… ä¿æŒå¼‚æ­¥é€šé“å¼€å¯
```

### Content.js çš„ç®€åŒ–é€»è¾‘

**æ–°æ–¹æ¡ˆä¼˜åŠ¿ï¼š**
- âœ… ç§»é™¤æ‰€æœ‰ XHR/Blob/Canvas å¤æ‚é€»è¾‘
- âœ… ç®€å•çš„ URL æå– + =s0 æ›¿æ¢
- âœ… ç›´æŽ¥å‘é€ç»™ Background å¤„ç†
- âœ… å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—

## ðŸš€ åº”ç”¨æ›´æ–°

### é‡è¦ï¼šå¿…é¡»é‡æ–°åŠ è½½æ’ä»¶

1. æ‰“å¼€ `chrome://extensions/`
2. æ‰¾åˆ°"å¤§é¦™è•‰æ‰¹é‡ç”Ÿå›¾"
3. ç‚¹å‡» **ðŸ”„ é‡æ–°åŠ è½½** æŒ‰é’®
4. åˆ·æ–° Gemini é¡µé¢

âš ï¸ **æ³¨æ„**ï¼šä»…åˆ·æ–°ç½‘é¡µä¸å¤Ÿï¼Œå¿…é¡»é‡æ–°åŠ è½½æ’ä»¶æ‰èƒ½ä½¿ manifest å’Œ background ç”Ÿæ•ˆï¼

## âœ… éªŒè¯æ¸…å•

å®Œæˆæ‰€æœ‰ä¿®æ”¹åŽï¼Œæµ‹è¯•ä»¥ä¸‹å†…å®¹ï¼š

- [ ] Console ä¸­çœ‹åˆ° "ðŸŒ Nano Banana Flow Service Worker å·²å¯åŠ¨"
- [ ] ç”Ÿæˆå›¾ç‰‡æ—¶ä¸å†æŠ¥ "Could not establish connection" é”™è¯¯
- [ ] Console æ˜¾ç¤º "[BG] æŽ¥æ”¶åˆ°ä¸‹è½½ä»»åŠ¡: pageX.png"
- [ ] Console æ˜¾ç¤º "âœ… [BG] ä¸‹è½½å·²å¯åŠ¨ (ID: xxx)"
- [ ] æ–‡ä»¶è‡ªåŠ¨ä¿å­˜åˆ°ä¸‹è½½æ–‡ä»¶å¤¹
- [ ] æ–‡ä»¶åä¸º page1.png, page2.png...
- [ ] æ–‡ä»¶å¤§å° > 1MBï¼ˆé«˜æ¸…åŽŸå›¾ï¼‰

## ðŸ” æ•…éšœæŽ’æŸ¥

### å¦‚æžœä»ç„¶æŠ¥é”™ï¼š

1. **æ£€æŸ¥ Service Worker çŠ¶æ€**
   - `chrome://extensions/` â†’ ç‚¹å‡»"Service Worker"
   - æŸ¥çœ‹æ˜¯å¦æœ‰é”™è¯¯æ—¥å¿—

2. **æ¸…é™¤æ’ä»¶ç¼“å­˜**
   - ç§»é™¤æ’ä»¶
   - é‡æ–°åŠ è½½æ’ä»¶
   - åˆ·æ–° Gemini é¡µé¢

3. **æ£€æŸ¥æƒé™**
   - ç¡®è®¤ manifest.json ä¸­æœ‰ "downloads" æƒé™
   - ç¡®è®¤ host_permissions åŒ…å« googleusercontent.com

## ðŸ“Š æ–°æž¶æž„æµç¨‹

```
Content Script                Background Script
     â”‚                              â”‚
     â”‚  1. æå–å›¾ç‰‡URL              â”‚
     â”‚  2. æ›¿æ¢ä¸º =s0               â”‚
     â”‚                              â”‚
     â”‚â”€â”€â”€â”€ sendMessage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚   {action: 'download_hq'}   â”‚
     â”‚                              â”‚
     â”‚                              â”‚ 3. chrome.downloads.download()
     â”‚                              â”‚ 4. è¿”å›ž downloadId
     â”‚<â”€â”€â”€â”€ sendResponse â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚                              â”‚
     â”‚  5. resolve() ç»§ç»­é˜Ÿåˆ—       â”‚
     â”‚                              â”‚
```

## ðŸ“ ä»£ç å¯¹æ¯”

| é¡¹ç›® | æ—§æ–¹æ¡ˆ | æ–°æ–¹æ¡ˆ |
|------|--------|--------|
| ä¸‹è½½ä½ç½® | Content Script | Background Script |
| é‰´æƒå¤„ç† | XHR withCredentials | Chrome API è‡ªåŠ¨å¤„ç† |
| é”™è¯¯å¤„ç† | å¤æ‚çš„é‡è¯•é€»è¾‘ | ç®€å•çš„å›žè°ƒæ£€æŸ¥ |
| ä»£ç è¡Œæ•° | ~150è¡Œ | ~65è¡Œ |
| é€šä¿¡æ–¹å¼ | å•å‘ | åŒå‘ï¼ˆå¸¦å“åº”ï¼‰ |

## ðŸŽ‰ é¢„æœŸç»“æžœ

- âœ… ä¸å†æœ‰è¿žæŽ¥é”™è¯¯
- âœ… ä¸‹è½½è‡ªåŠ¨è¿›è¡Œ
- âœ… åŽŸå›¾è´¨é‡ï¼ˆ=s0ï¼‰
- âœ… æ­£ç¡®æ–‡ä»¶å
- âœ… ä¸²è¡Œæµç¨‹ç¨³å®š
