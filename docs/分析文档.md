# Gemini 无损去水印功能集成分析文档

## 1. 背景介绍
`Nano-Banana-Flow` 是一个用于 Gemini 的批量生图工具。目前生成的图片在右下角带有 Gemini 的官方可见水印（透明 Logo）。为了提供更好的用户体验，计划集成 `gemini-watermark-remover` 的核心逻辑，在图片下载过程中自动实现去水印处理。

## 2. 核心算法分析
`gemini-watermark-remover` 采用了**数学精确的反向 Alpha 混合算法**，而非 AI 修复。其核心原理如下：

### 2.1 混合公式
Gemini 的水印合成公式为：
`watermarked = α ⋅ logo + (1 - α) ⋅ original`

### 2.2 反向求解
为了恢复原始像素 `original`，公式变形为：
`original = (watermarked - α ⋅ logo) / (1 - α)`

### 2.3 关键组件
- **Alpha Map**: 通过预先捕获的水印背景图（`bg_48.png` 和 `bg_96.png`）计算出水印的 Alpha 通道掩码。
- **Watermark Engine**: 负责检测图像尺寸、计算水印位置并应用反向混合公式。
- **Canvas API**: 算法依赖浏览器 Canvas 进行像素级操作（`getImageData` 和 `putImageData`）。

## 3. 当前下载流程分析 (Nano-Banana-Flow)
目前 `Nano-Banana-Flow` 的下载链路如下：
1. **Content Script (`content.js`)**: 捕获页面上的图片 URL，并将其转化为高清 URL（替换 `=sXXX` 为 `=s0`）。
2. **消息传递**: `content.js` 通过 `chrome.runtime.sendMessage` 发送 `action: 'download_hq'` 到 `background.js`。
3. **Background Script (`background.js`)**: 调用 `chrome.downloads.download` 直接下载原始图片 URL。

## 4. 集成方案对比

| 方案 | 优点 | 缺点 | 结论 |
| :--- | :--- | :--- | :--- |
| **方案 A: Background 处理** | 逻辑集中在后台 | MV3 Service Worker 不支持 Canvas 和 DOM，实现困难 | 不推荐 |
| **方案 B: Content Script 处理** | 拥有完整的 Canvas 访问权，逻辑直接 | 可能会轻微占用页面资源，需要处理跨域 Fetch | **推荐** |
| **方案 C: Offscreen Document** | 符合 MV3 规范，后台静默处理 | 引入额外 API 复杂度，在插件中显得沉重 | 备选 |

## 5. 结论
我们将采用**方案 B**。在 `content.js` 准备下载任务时，先通过 Fetch 获取图片 Blob，然后利用 Canvas 在内存中完成去水印处理，最后将处理后的数据（Data URL 或 Blob URL）交给 `background.js` 进行最终保存。
